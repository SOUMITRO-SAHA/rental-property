// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  // url      = env("DATABASE_URL_LOCAL")
  url      = env("DATABASE_URL_TEST")
}

enum AuthRoles {
  USER
  ADMIN
  MANAGER
  TENDER
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

model User {
  id                   Int       @id @default(autoincrement())
  name                 String
  email                String    @unique
  password             String
  imageUrl             String    @default("")
  token                String?
  forgotPasswordToken  String?
  forgotPasswordExpiry DateTime?
  chatId               Int?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  role                 AuthRoles @default(USER)

  chat             Chat[]
  appointments     Appointment[]
  tickets          Ticket[]
  properties       Property[]
  sentMessages     Message[]       @relation("SentMessages")
  receivedMessages Message[]       @relation("ReceivedMessages")
  messageStatus    MessageStatus[]
  notifications    Notification[]

  @@index([chatId])
}

model Amenity {
  id              Int               @id @default(autoincrement())
  name            String
  icon            String            @default("")
  PropertyAmenity PropertyAmenity[]
}

model Property {
  id                 Int      @id @default(autoincrement())
  views              Int      @default(0)
  likes              Int      @default(0)
  userId             Int
  numberOfBedrooms   Int      @default(0)
  numberOfBathrooms  Int      @default(0)
  otherRooms         String?
  brokerageCharge    String?
  possession         String   @default("Immediate")
  hasBalcony         Boolean  @default(false)
  hasPowerBackup     Boolean  @default(false)
  propertyType       String   @default("Residential")
  isApartment        Boolean  @default(false)
  buildingAge        String   @default("New")
  floor              String   @default("Ground Floor")
  totalFloor         String   @default("1")
  buildupArea        Float    @default(0)
  buildingType       String   @default("Other")
  furnishingStatus   String   @default("Unfurnished")
  expectedRent       String   @default("Contact for rent")
  expectedDeposit    String   @default("Contact for deposit")
  rentNegotiable     Boolean  @default(true)
  maintenanceCharges Float    @default(0)
  availableDate      DateTime @default(now())
  gatedSecurity      Boolean  @default(false)
  ownershipType      String   @default("Freehold")
  flooring           String   @default("Other")
  hasParking         Boolean  @default(false)
  carpetArea         Float    @default(0)
  facing             String   @default("Other")
  phone              String   @default("")
  description        String?
  address            String?
  streetAddress      String?
  city               String?
  state              String?
  postalCode         String?
  country            String?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  // Relationship
  user      User              @relation(fields: [userId], references: [id])
  Photo     Photo[]           @relation("PropertyPhotos")
  amenities PropertyAmenity[]
}

// Junction table that connects properties to amenities in a many-to-many relationship
model PropertyAmenity {
  id         Int      @id @default(autoincrement())
  property   Property @relation(fields: [propertyId], references: [id])
  propertyId Int
  amenity    Amenity  @relation(fields: [amenityId], references: [id])
  amenityId  Int
}

model Photo {
  id         Int      @id @default(autoincrement())
  url        String
  property   Property @relation("PropertyPhotos", fields: [propertyId], references: [id])
  propertyId Int
}

model Appointment {
  id          Int      @id @default(autoincrement())
  userId      Int
  user        User     @relation(fields: [userId], references: [id])
  startTime   DateTime
  endTime     DateTime
  description String?
}

model Ticket {
  id          Int          @id @default(autoincrement())
  userId      Int
  subject     String
  description String
  status      TicketStatus @default(OPEN)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  user        User         @relation(fields: [userId], references: [id])
}

model Banner {
  id       Int     @id @default(autoincrement())
  imageUrl String?
}

model Feedback {
  id           Int     @id @default(autoincrement())
  email        String?
  fullName     String?
  mobileNumber String?
  message      String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Chat {
  id          Int      @id @default(autoincrement())
  name        String?
  description String?
  isGroupChat Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  participants User[]
  messages     Message[]
}

model Message {
  id         Int      @id @default(autoincrement())
  content    String   @db.Text
  senderId   Int
  receiverId Int
  chatId     Int?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  Chat     Chat? @relation(fields: [chatId], references: [id])
  sender   User  @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  receiver User  @relation("ReceivedMessages", fields: [receiverId], references: [id], onDelete: Cascade)

  attachments   Attachment[]
  messageStatus MessageStatus[]
  Notification  Notification[]
}

model Attachment {
  id        Int      @id @default(autoincrement())
  url       String
  localPath String
  messageId Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  message Message @relation(fields: [messageId], references: [id], onDelete: Cascade)
}

model Notification {
  id        Int      @id @default(autoincrement())
  userId    Int
  messageId Int
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user    User    @relation(fields: [userId], references: [id])
  message Message @relation(fields: [messageId], references: [id])
}

model MessageStatus {
  id        Int      @id @default(autoincrement())
  userId    Int
  messageId Int
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  message Message @relation(fields: [messageId], references: [id])
  user    User    @relation(fields: [userId], references: [id])
}
